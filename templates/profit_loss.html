{% extends "base.html" %}
{% block title %}Profit/Loss Report{% endblock %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-graph-up"></i> Profit/Loss Report</h1>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h6 class="card-title">Total Revenue</h6>
                <h2>Rs. {{ "%.2f"|format(total_revenue) }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-secondary text-white">
            <div class="card-body text-center">
                <h6 class="card-title">Total Cost</h6>
                <h2>Rs. {{ "%.2f"|format(total_cost) }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card {% if total_profit >= 0 %}bg-success{% else %}bg-danger{% endif %} text-white">
            <div class="card-body text-center">
                <h6 class="card-title">Net Profit/Loss</h6>
                <h2>Rs. {{ "%.2f"|format(total_profit) }}</h2>
                <small>Margin: {{ "%.2f"|format(profit_margin) }}%</small>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header"><h5>Sales Details</h5></div>
    <div class="card-body">
        {% if sales %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Invoice</th>
                        <th>Customer</th>
                        <th>Revenue</th>
                        <th>Estimated Cost</th>
                        <th>Profit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    {% set items = sale.items|fromjson %}
                    {% set sale_cost = 0 %}
                    {% for item in items %}
                        {% set battery = batteries|selectattr("barcode", "equalto", item.barcode)|first %}
                        {% if battery %}
                            {% set sale_cost = sale_cost + (battery.purchase_price * item.quantity) %}
                        {% endif %}
                    {% endfor %}
                    {% set sale_profit = sale.total - sale_cost %}
                    <tr>
                        <td>{{ sale.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>{{ sale.invoice_number }}</td>
                        <td>{{ sale.customer_name }}</td>
                        <td>Rs. {{ "%.2f"|format(sale.total) }}</td>
                        <td>Rs. {{ "%.2f"|format(sale_cost) }}</td>
                        <td class="{% if sale_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                            Rs. {{ "%.2f"|format(sale_profit) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <h4 class="text-muted">No sales found in this date range</h4>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}